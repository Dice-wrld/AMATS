{% extends 'asset_management/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-primary mb-4">
        <i class="bi bi-qr-code-scan me-2"></i>QR Code Scanner
    </h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Scan Asset QR Code
                </div>
                <div class="card-body text-center">
                    <!-- Start Section -->
                    <div id="start-section">
                        <button class="btn btn-lg btn-success mb-3" onclick="startScanner()">
                            <i class="bi bi-camera-fill me-2"></i>Start Scanning
                        </button>
                        <p class="text-muted">Click to activate camera and begin scanning</p>
                    </div>
                    
                    <!-- Scanner Section -->
                    <div id="scanner-section" style="display: none;">
                        <div id="reader" style="width: 100%;"></div>
                    </div>
                    
                    <div id="result" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Manual Entry
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'qr_lookup' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">QR Code Data</label>
                            <input type="text" name="qr_data" class="form-control" placeholder="Scan or type QR data...">
                        </div>
                        <button type="submit" class="btn btn-primary">Lookup Asset</button>
                    </form>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    Instructions
                </div>
                <div class="card-body">
                    <ol>
                        <li>Click "Start Scanning" button</li>
                        <li>Allow camera access when prompted</li>
                        <li>Point camera at asset QR code</li>
                        <li>System will automatically detect and lookup</li>
                        <li>Use camera's stop button when done</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
let html5QrcodeScanner = null;

function startScanner() {
    // Hide start button, show scanner
    document.getElementById('start-section').style.display = 'none';
    document.getElementById('scanner-section').style.display = 'block';
    document.getElementById('result').innerHTML = '';
    
    // Initialize scanner
    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: {width: 250, height: 250} },
        false
    );
    
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
}

function onScanSuccess(decodedText, decodedResult) {
    // Show scanning message
    document.getElementById('result').innerHTML = 
        '<div class="alert alert-info">QR Code detected! Looking up asset...</div>';
    
    // Send to server
    fetch("{% url 'qr_lookup' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'qr_data=' + encodeURIComponent(decodedText)
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            document.getElementById('result').innerHTML = 
                '<div class="alert alert-warning">Asset not found. Please try again.</div>';
        }
    })
    .catch(error => {
        document.getElementById('result').innerHTML = 
            '<div class="alert alert-danger">Error: ' + error + '</div>';
    });
}

function onScanFailure(error) {
    // Scan failure - silently ignore
}
</script>
{% endblock %}